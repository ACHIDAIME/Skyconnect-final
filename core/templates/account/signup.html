{% extends 'core/base.html' %}
{% load static %}
{% block title %}Inscription - SKYCONNECT{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg border-0" style="border-radius: 15px; background: rgba(255, 255, 255, 0.95);">
                <div class="card-body p-5 text-center">
                    <div style="font-size: 3rem; color: var(--rouge-sky); margin-bottom: 20px;">
                        <i class="bi bi-google"></i>
                    </div>
                    <h2 style="color: var(--rouge-sky); font-weight: bold; margin-bottom: 20px;">Créer un compte</h2>
                    <p style="color: #666; font-size: 1.05rem; margin-bottom: 30px;">
                        Pour rejoindre SKYCONNECT, connectez-vous simplement avec votre compte Google. Un compte sera créé automatiquement.
                    </p>

                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <div id="g_id_onload"
                         data-client_id="494438941780-3h58rioc40afemr6hb87blskk6mn6bhi.apps.googleusercontent.com"
                         data-context="signin"
                         data-ux_mode="redirect"
                         data-login_uri="http://localhost:8080/auth-receiver"
                         data-itp_support="true">
                    </div>
                    <div class="g_id_signin"
                         data-type="standard"
                         data-shape="pill"
                         data-theme="outline"
                         data-text="signup_with"
                         data-size="large"
                         data-logo_alignment="left">
                    </div>

                    <hr class="my-4">
                    <p style="color: #999; font-size: 0.9rem;">Vous avez déjà un compte ?</p>
                    <a href="{% url 'account_login' %}" class="btn btn-outline-primary" style="border-color: var(--rouge-sky); color: var(--rouge-sky); border-radius: 25px;">
                        <i class="bi bi-box-arrow-in-right me-2"></i>Se connecter
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        backdrop-filter: blur(10px);
    }
    .g_id_signin {
        margin: 0 auto;
        display: flex;
        justify-content: center;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const card = document.querySelector('.card');
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease-out';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 100);

        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            setTimeout(function() {
                alert.style.transition = 'opacity 0.5s ease-out';
                alert.style.opacity = '0';
                setTimeout(function() {
                    alert.remove();
                }, 500);
            }, 5000);
        });
    });
</script>
{% endblock %}

                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.last_name.id_for_label }}" class="form-label" style="color: var(--rouge-sky); font-weight: 500;">
                                        <i class="bi bi-person me-1"></i>Nom *
                                    </label>
                                    <input type="text" name="last_name" class="form-control" id="{{ form.last_name.id_for_label }}"
                                           placeholder="Votre nom" required style="border-radius: 10px;">
                                    {% if form.last_name.errors %}
                                        <div class="text-danger small mt-1">
                                            <i class="bi bi-exclamation-triangle me-1"></i>{{ form.last_name.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.email.id_for_label }}" class="form-label" style="color: var(--rouge-sky); font-weight: 500;">
                                    <i class="bi bi-envelope me-1"></i>Adresse email *
                                </label>
                                <input type="email" name="email" class="form-control" id="{{ form.email.id_for_label }}"
                                       placeholder="votre.email@exemple.com" required style="border-radius: 10px;">
                                <div class="form-text">
                                    <i class="bi bi-shield-check me-1"></i>Nous ne partagerons jamais votre email avec des tiers.
                                </div>
                                {% if form.email.errors %}
                                    <div class="text-danger small mt-1">
                                        <i class="bi bi-exclamation-triangle me-1"></i>{{ form.email.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Sécurité du compte -->
                        <div class="mb-4">
                            <h5 style="color: var(--rouge-sky); font-weight: 600; margin-bottom: 20px;">
                                <i class="bi bi-shield-lock me-2"></i>Sécurité du compte
                            </h5>

                            <div class="mb-3">
                                <label for="{{ form.password1.id_for_label }}" class="form-label" style="color: var(--rouge-sky); font-weight: 500;">
                                    <i class="bi bi-key me-1"></i>Mot de passe *
                                </label>
                                <div class="input-group">
                                    <input type="password" name="password1" class="form-control" id="{{ form.password1.id_for_label }}"
                                           placeholder="Créez un mot de passe sécurisé" required style="border-radius: 10px 0 0 10px;">
                                    <button class="btn btn-outline-secondary" type="button" id="togglePassword1" style="border-radius: 0 10px 10px 0;">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div id="passwordStrength" class="mt-2">
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar" role="progressbar" style="width: 0%; border-radius: 3px;"></div>
                                    </div>
                                    <small id="passwordHelp" class="form-text text-muted">
                                        <i class="bi bi-info-circle me-1"></i>Le mot de passe doit contenir au moins 8 caractères.
                                    </small>
                                </div>
                                {% if form.password1.errors %}
                                    <div class="text-danger small mt-1">
                                        <i class="bi bi-exclamation-triangle me-1"></i>{{ form.password1.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.password2.id_for_label }}" class="form-label" style="color: var(--rouge-sky); font-weight: 500;">
                                    <i class="bi bi-key-fill me-1"></i>Confirmer le mot de passe *
                                </label>
                                <div class="input-group">
                                    <input type="password" name="password2" class="form-control" id="{{ form.password2.id_for_label }}"
                                           placeholder="Confirmez votre mot de passe" required style="border-radius: 10px 0 0 10px;">
                                    <button class="btn btn-outline-secondary" type="button" id="togglePassword2" style="border-radius: 0 10px 10px 0;">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div id="passwordMatch" class="mt-1" style="display: none;">
                                    <small class="text-success"><i class="bi bi-check-circle me-1"></i>Mots de passe identiques</small>
                                </div>
                                {% if form.password2.errors %}
                                    <div class="text-danger small mt-1">
                                        <i class="bi bi-exclamation-triangle me-1"></i>{{ form.password2.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger" style="border-radius: 10px;">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Conditions et validation -->
                        <div class="mb-4">
                            <div class="border rounded p-3" style="background: #f8f9fa; border-color: #dee2e6;">
                                <div class="form-check mb-2">
                                    <input type="checkbox" class="form-check-input" id="terms" name="terms" required>
                                    <label class="form-check-label" for="terms" style="font-size: 14px;">
                                        J'accepte les <a href="{% url 'mentions_legales' %}" target="_blank" style="color: var(--rouge-sky); text-decoration: none; font-weight: 500;">conditions générales d'utilisation</a> *
                                    </label>
                                </div>

                                <div class="form-check mb-2">
                                    <input type="checkbox" class="form-check-input" id="privacy" name="privacy" required>
                                    <label class="form-check-label" for="privacy" style="font-size: 14px;">
                                        J'accepte la <a href="#" style="color: var(--rouge-sky); text-decoration: none; font-weight: 500;">politique de confidentialité</a> *
                                    </label>
                                </div>

                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="newsletter" name="newsletter">
                                    <label class="form-check-label" for="newsletter" style="font-size: 14px; color: #666;">
                                        Je souhaite recevoir la newsletter SKYCONNECT (optionnel)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mb-3" id="submitBtn"
                                style="background-color: var(--rouge-sky); border-color: var(--rouge-sky); border-radius: 25px; padding: 14px; font-weight: bold; font-size: 16px;">
                            <i class="bi bi-person-plus me-2"></i>Créer mon compte SKYCONNECT
                        </button>
                    </form>

                    <!-- Séparateur -->
                    <div class="text-center mb-4">
                        <div class="position-relative">
                            <hr style="border-color: #dee2e6;">
                            <span class="position-absolute top-50 start-50 translate-middle px-3"
                                  style="background: white; color: #666; font-size: 14px;">ou</span>
                        </div>
                    </div>

                    <!-- Connexion Google -->
                    <div class="text-center mb-4">
                        <p class="mb-3" style="color: #666; font-size: 15px;">Continuez avec votre compte Google</p>
                        <div id="g_id_onload"
                             data-client_id="494438941780-3h58rioc40afemr6hb87blskk6mn6bhi.apps.googleusercontent.com"
                             data-context="signup"
                             data-ux_mode="redirect"
                             data-login_uri="http://localhost:8080/auth-receiver"
                             data-itp_support="true">
                        </div>
                        <div class="g_id_signin"
                             data-type="standard"
                             data-shape="pill"
                             data-theme="outline"
                             data-size="large"
                             style="margin: 0 auto;">
                        </div>
                    </div>

                    <!-- Lien vers connexion -->
                    <div class="text-center">
                        <p class="mb-2" style="color: #666;">Vous avez déjà un compte ?</p>
                        <a href="{% url 'account_login' %}" class="btn btn-outline-primary"
                           style="border-color: var(--rouge-sky); color: var(--rouge-sky); border-radius: 25px; padding: 10px 24px;">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Se connecter
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        backdrop-filter: blur(10px);
        animation: slideInUp 0.6s ease-out;
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .form-control {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        padding: 12px 16px;
        font-size: 16px;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: var(--rouge-sky);
        box-shadow: 0 0 0 0.2rem rgba(118, 16, 35, 0.25);
        transform: translateY(-1px);
    }

    .form-control.is-valid {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }

    .form-control.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    .btn-primary {
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background-color: #5a0d1a;
        border-color: #5a0d1a;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(118, 16, 35, 0.3);
    }

    .btn-outline-primary:hover {
        background-color: var(--rouge-sky);
        border-color: var(--rouge-sky);
        transform: translateY(-1px);
    }

    .progress-bar {
        transition: width 0.3s ease;
    }

    .password-strength-weak {
        background-color: #dc3545;
    }

    .password-strength-medium {
        background-color: #ffc107;
    }

    .password-strength-strong {
        background-color: #28a745;
    }

    .g_id_signin {
        margin: 0 auto;
    }

    .input-group .btn {
        border-color: #ced4da;
    }

    .input-group .btn:hover {
        background-color: #f8f9fa;
    }

    .alert {
        border-radius: 10px;
        border: none;
    }

    .form-check-input:checked {
        background-color: var(--rouge-sky);
        border-color: var(--rouge-sky);
    }

    .form-check-input:focus {
        border-color: var(--rouge-sky);
        box-shadow: 0 0 0 0.2rem rgba(118, 16, 35, 0.25);
    }

    /* Animation pour les erreurs */
    .error-shake {
        animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const signupForm = document.getElementById('signupForm');
    const password1 = document.getElementById('{{ form.password1.id_for_label }}');
    const password2 = document.getElementById('{{ form.password2.id_for_label }}');
    const passwordStrength = document.getElementById('passwordStrength');
    const passwordHelp = document.getElementById('passwordHelp');
    const passwordMatch = document.getElementById('passwordMatch');
    const submitBtn = document.getElementById('submitBtn');
    const progressBar = passwordStrength.querySelector('.progress-bar');

    // Toggle visibilité mot de passe
    document.getElementById('togglePassword1').addEventListener('click', function() {
        togglePasswordVisibility(password1, this);
    });

    document.getElementById('togglePassword2').addEventListener('click', function() {
        togglePasswordVisibility(password2, this);
    });

    function togglePasswordVisibility(input, button) {
        const icon = button.querySelector('i');
        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'bi bi-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'bi bi-eye';
        }
    }

    // Vérification de la force du mot de passe
    password1.addEventListener('input', function() {
        const password = this.value;
        const strength = checkPasswordStrength(password);
        updatePasswordStrength(strength);
        checkPasswordMatch();
    });

    password2.addEventListener('input', function() {
        checkPasswordMatch();
    });

    function checkPasswordStrength(password) {
        let score = 0;

        // Longueur
        if (password.length >= 8) score += 25;
        if (password.length >= 12) score += 25;

        // Complexité
        if (/[a-z]/.test(password)) score += 10;
        if (/[A-Z]/.test(password)) score += 10;
        if (/[0-9]/.test(password)) score += 10;
        if (/[^A-Za-z0-9]/.test(password)) score += 10;

        return Math.min(score, 100);
    }

    function updatePasswordStrength(strength) {
        progressBar.style.width = strength + '%';

        progressBar.className = 'progress-bar';
        if (strength < 40) {
            progressBar.classList.add('password-strength-weak');
            passwordHelp.innerHTML = '<i class="bi bi-shield-x me-1"></i>Mot de passe faible - Ajoutez des majuscules, chiffres et symboles';
            passwordHelp.className = 'form-text text-danger';
        } else if (strength < 70) {
            progressBar.classList.add('password-strength-medium');
            passwordHelp.innerHTML = '<i class="bi bi-shield-check me-1"></i>Mot de passe moyen - Encore quelques améliorations possibles';
            passwordHelp.className = 'form-text text-warning';
        } else {
            progressBar.classList.add('password-strength-strong');
            passwordHelp.innerHTML = '<i class="bi bi-shield-fill-check me-1"></i>Mot de passe fort - Excellent choix !';
            passwordHelp.className = 'form-text text-success';
        }
    }

    function checkPasswordMatch() {
        const match = password1.value === password2.value && password1.value.length > 0;
        passwordMatch.style.display = match ? 'block' : 'none';

        if (password2.value.length > 0) {
            password2.classList.toggle('is-valid', match);
            password2.classList.toggle('is-invalid', !match);
        } else {
            password2.classList.remove('is-valid', 'is-invalid');
        }
    }

    // Validation du formulaire
    signupForm.addEventListener('submit', function(e) {
        let isValid = true;

        // Vérifier les champs requis
        const requiredFields = ['first_name', 'last_name', 'email', 'password1', 'password2'];
        requiredFields.forEach(fieldName => {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (!field.value.trim()) {
                field.classList.add('is-invalid', 'error-shake');
                setTimeout(() => field.classList.remove('error-shake'), 500);
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
            }
        });

        // Vérifier les checkboxes
        const terms = document.getElementById('terms');
        const privacy = document.getElementById('privacy');

        if (!terms.checked) {
            terms.closest('.border').classList.add('error-shake');
            setTimeout(() => terms.closest('.border').classList.remove('error-shake'), 500);
            isValid = false;
        }

        if (!privacy.checked) {
            privacy.closest('.border').classList.add('error-shake');
            setTimeout(() => privacy.closest('.border').classList.remove('error-shake'), 500);
            isValid = false;
        }

        // Vérifier la force du mot de passe
        const strength = checkPasswordStrength(password1.value);
        if (strength < 40) {
            password1.classList.add('is-invalid', 'error-shake');
            setTimeout(() => password1.classList.remove('error-shake'), 500);
            isValid = false;
        }

        if (!isValid) {
            e.preventDefault();
            submitBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Veuillez corriger les erreurs';
            submitBtn.classList.add('btn-danger');
            setTimeout(() => {
                submitBtn.innerHTML = '<i class="bi bi-person-plus me-2"></i>Créer mon compte SKYCONNECT';
                submitBtn.classList.remove('btn-danger');
            }, 3000);
        } else {
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Création en cours...';
            submitBtn.disabled = true;
        }
    });

    // Animation d'entrée
    const card = document.querySelector('.card');
    card.style.opacity = '0';
    card.style.transform = 'translateY(30px)';
    setTimeout(() => {
        card.style.transition = 'all 0.6s ease-out';
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
    }, 100);
});
</script>
{% endblock %}