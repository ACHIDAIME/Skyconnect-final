<!-- filepath: c:\Users\mirab\Desktop\Stage\skyconnect-finalisation\core\templates\core\equipements.html -->
{% extends 'core/base.html' %}
{% block title %}Équipements - Sky Connect{% endblock %}

{% block content %}
<section class="container my-5">
  <h2 class="mb-4 fw-bold text-center" style="color:var(--rouge-sky);">Nos Équipements et Accessoires</h2>
  {% for categorie in categories %}
  {% if categorie.sous_categories.all %}
    <h3 class="mt-5 mb-3" style="color:var(--rouge-sky);">{{ categorie.nom }}</h3>
    {% for sous_categorie in categorie.sous_categories.all %}
      {% if sous_categorie.produits.all %}
        <h4 class="mb-3">{{ sous_categorie.nom }}</h4>
        <div class="row g-4 mb-4">
          {% for produit in sous_categorie.produits.all|slice:":4" %}
            <div class="col-md-3 d-flex align-items-stretch">
              <div class="card h-100 border-danger shadow-sm">
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title">{{ produit.nom }}</h5>
                  {% if produit.image %}
                    <a href="{% url 'produit_detail' produit.id %}">
                      <img src="{{ produit.image.url }}" alt="{{ produit.nom }}" class="img-fluid mb-2">
                    </a>
                  {% endif %}
                  {{ produit.description|truncatechars:60 }}
                  <a href="{% url 'produit_detail' produit.id %}" class="btn btn-link p-0" style="color:var(--rouge-sky-lighter);">Voir plus</a>
                  <div class="mt-auto price-halo" style="color:var(--rouge-sky);">{{ produit.prix|floatformat:0 }} GNF</div>
                  {% if produit.quantite > 0 %}
                    <button class="btn btn-animated mt-2" onclick="ajouterAuPanier({{ produit.id }})">Ajouter au panier</button>
                  {% else %}
                    <button class="btn btn-outline-secondary mt-2" disabled>Indisponible</button>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}
</section>
<!-- Modal de confirmation -->
<div class="modal fade" id="panierModal" tabindex="-1" aria-labelledby="panierModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="panierModalLabel">Produit ajouté au panier</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <p>Voulez-vous continuer vers le panier ou poursuivre vos achats ?</p>
        <div class="d-flex justify-content-center gap-3">
          <a id="versPanierBtn" href="#" class="btn btn-outline-secondary">Aller au panier</a>
          <button type="button" class="btn btn-animated" data-bs-dismiss="modal">Poursuivre les achats</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function ajouterAuPanier(produitId) {
  fetch("{% url 'ajouter_au_panier' 0 %}".replace('0', produitId), {
    headers: {'X-Requested-With': 'XMLHttpRequest'}
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Met à jour le compteur du panier dans la navbar
      document.querySelectorAll('.panier-count').forEach(function(el) {
        el.textContent = data.panier_count;
      });
      // Affiche le modal
      document.getElementById('versPanierBtn').href = "{% url 'panier' %}";
      var modal = new bootstrap.Modal(document.getElementById('panierModal'));
      modal.show();
    }
  });
}
</script>
{% endblock %}